# 5.3. `Message` (JPA Entity)

The `Message` entity represents a **persisted chat message** stored in the database.

It is different from the WebSocketDTO `ChatMessage`
- `ChatMessage` â†’ real-time transport object
- `Message`â†’ database entity representing a historical chat entry

```java
package com.chatapp.chat.chat.message;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.CreationTimestamp;

import java.time.Instant;
import java.util.UUID;

@Entity
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "messages")
public class Message {

    @Id
    @GeneratedValue
    private UUID id;

    @Column(nullable = false)
    private String chatId;

    @Column(nullable = false)
    private String sender;

    @Column(nullable = false, columnDefinition = "TEXT")
    private String content;

    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private Instant createdAt;
}

```

---

## ğŸ“ Purpose

This entity stores **every chat message** in the `messages` table, enabling:
- chat history retrieval
- persistent storage of user communication
- chronological sorting
- message replay for clients joining late

It is used by:
- `MessageRepository`
- `MessageService`
- `MessageController`

--- 

## ğŸ“Œ Field-by-Field Explanation

### `id`

```java
@Id
@GeneratedValue
private UUID id;
```

- Primary key
- Automatically generated as a UUID
- Immutable
- Exposed in API responses via `MessageResponse`

---

### `chatId`

```java
@Column(nullable = false)
private String chatId;
```

The identifier of the chat room to which the message belongs.

Used for:
- filtering chat history
- grouping messages by conversation
- topic-based broadcasting (`/topic/chat.{chatId}`)

---

### `sender`

```java
@Column(nullable = false)
private String sender;
```

The username of the author of the message.

Persistent, unlike `Principal`/SecurityContext, which is used only during authentication.

---

### `content`

```java
@Column(nullable = false, columnDefinition = "TEXT")
private String content;
```

---

### `createdAt`

```java
@CreationTimestamp
@Column(nullable = false, updatable = false)
private Instant createdAt;
```

Automatically set by Hibernate when the row is inserted.
Cannot be manually overwritten.

Used for:
- ordering chat history (`ORDER BY created_at ASC`)
- displaying timestamps to clients

---

## ğŸ”„ Life Cycle

### Created during WebSocket message handling:
1. Client sends a `ChatMessage` via WebSocket
2. `ChatController.sendMessage()` receives it
3. The DTO is converted into a `Message` entity
4. Saved via `MessageService.save()`
5. Response is broadcast to the chat room

--- 

## ğŸ“‚ Database Table


| Column     | Type      | Constraints              |
|:-----------|:----------|--------------------------|
| id         | UUID      | PK, generated            |
| chat_id    | VARCHAR   | NOT NULL                 |
| sender     | VARCHAR   | NOT NULL                 |
| content    | TEXT      | NOT NULL                 |
| created_at | TIMESTAMP | NOT NULL, auto-generated |

--- 

## ğŸ— Example JSON Representation

(When converted via `MessageResponse`)

```json
{
  "id": "f32f0b5d-98d2-4e89-9bcb-f7e67f210fc1",
  "chatId": "room-123",
  "sender": "alice",
  "content": "Hello, world!",
  "createdAt": "2026-02-01T12:43:20.123Z"
}
```

---

## âœ” Summary

`Message` is the **persistent data model** for storing chat messages. It forms the backbone of the chat history system 
and works closely with:
- `ChatController` â†’ saves messages
- `MessageService` â†’ business logic
- `MessageRepository` â†’ database operations
- `MessageResponse` â†’ REST responses

It is simple, efficient, immutable after creation (except for content edits if added in the future), and optimized for 
chronological storage.