# 5.3. `Message` (JPA Entity)

The `Message` entity represents a **persisted chat message** stored in the database.

It is different from WebSocket DTOs (`WsInboundMessage`, `WsOutboundMessage`):
- `WsInboundMessage` â†’ real-time transport object received over WebSocket
- `Message` â†’ database entity representing a historical chat entry
- `WsOutboundMessage` â†’ structured WebSocket response sent to clients

```java
package com.chatapp.chat.chat.message;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.CreationTimestamp;

import java.time.Instant;
import java.util.UUID;

@Entity
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "messages")
public class Message {

    @Id
    @GeneratedValue
    private UUID id;

    @Column(nullable = false)
    private String chatId;

    @Column(nullable = false)
    private String sender;

    @Column(nullable = false, columnDefinition = "TEXT")
    private String content;

    @CreationTimestamp
    @Column(nullable = false, updatable = false)
    private Instant createdAt;
}

```

---

## ğŸ“ Purpose

This entity stores **every chat message** in the `messages` table, enabling:
- chat history retrieval
- persistent storage of user communication
- chronological sorting
- message replay for clients joining late

It is used by:
- `MessageRepository`
- `MessageService`
- `MessageController`

--- 

## ğŸ“Œ Field-by-Field Explanation

### `id`

```java
@Id
@GeneratedValue
private UUID id;
```

- Primary key
- Automatically generated as a UUID
- Immutable
- Exposed in API responses via `MessageResponse`

---

### `chatId`

```java
@Column(nullable = false)
private String chatId;
```

Identifies the chat room (1-to-1 or group).

Used for:
- querying messages for a given chat
- grouping all chat-related content
- routing WebSocket broadcasts via `/topic/chat.{chatId}`

---

### `sender`

```java
@Column(nullable = false)
private String sender;
```

The username of the author of the message.

Persistent, unlike `Principal`/SecurityContext, which is used only during authentication.

---

### `content`

```java
@Column(nullable = false, columnDefinition = "TEXT")
private String content;
```

Text content of the message.

---

### `createdAt`

```java
@CreationTimestamp
@Column(nullable = false, updatable = false)
private Instant createdAt;
```

Automatically set by Hibernate when the row is inserted.
Cannot be manually overwritten.

Used for:
- ordering chat history (`ORDER BY created_at ASC`)
- displaying timestamps to clients

---

## ğŸ”„ Life Cycle

### Created during WebSocket message handling:
1. Client sends a `WsInboundMessage` via WebSocket
2. `WsChatController.sendMessage()` receives it
3. The DTO is converted into a `Message` entity
4. Saved via `MessageService.save()`
5. A **WsOutboundMessage** is broadcast to all subscribers of this chat

--- 

## ğŸ“‚ Database Table


| Column     | Type      | Constraints              |
|:-----------|:----------|--------------------------|
| id         | UUID      | PK, generated            |
| chat_id    | VARCHAR   | NOT NULL                 |
| sender     | VARCHAR   | NOT NULL                 |
| content    | TEXT      | NOT NULL                 |
| created_at | TIMESTAMP | NOT NULL, auto-generated |

--- 

## ğŸ— Example JSON Representation

(Delivered via REST API as `MessageResponse`)

```json
{
  "id": "f32f0b5d-98d2-4e89-9bcb-f7e67f210fc1",
  "chatId": "room-123",
  "sender": "alice",
  "content": "Hello, world!",
  "createdAt": "2026-02-01T12:43:20.123Z"
}
```

---

## âœ” Summary

`Message` is the **persistent data model** for storing chat messages. <br>
It forms the backbone of the chat history system and works closely with:
- `WsChatController` â†’ converts `WsInboundMessage` into `Message`
- `MessageService` â†’ business logic
- `MessageRepository` â†’ database operations
- `MessageResponse` â†’ REST responses

The entity is immutable after creation (except for future editing features)  
and optimized for chronological retrieval.