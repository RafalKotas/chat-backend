# 8. SonarQube Integration Guide

This project integrates with **SonarQube 10.x Community Edition** to provide:

- Static code analysis
- Code smells detection
- Vulnerability reporting
- Test coverage reporting (JaCoCo)

SonarQube runs locally via Docker and analysis is executed using a PowerShell script.

---

## üì¶ 1. Prerequisites

You need:
- Docker Desktop running
- A working SonarQube container
- Java 21+
- Maven 3.9+
- A valid SonarQube **User Token**

---

## üê≥ 2. Running SonarQube with Docker

The project includes:

docker-compose.sonar.yml

Start SonarQube:

```powershell
docker compose -f docker-compose.sonar.yml up -d
```

Check server status:
```powershell
http://localhost:9000/api/system/status
```

Expected result:

```json
{"status": "UP"}
```

---

## üîê 3. Generating a Token

Inside SonarQube Web UI:

**My Account ‚Üí Security ‚Üí Tokens ‚Üí Generate Token**
- Choose any name
- Type: User Token
- Save the token somewhere safe (you cannot view it again)

---

## üåç 4. Setting Up Environment Variable

Before running analysis, you must set:

### PowerShell (Windows)
```powershell
$env:SONAR_TOKEN="your_token_here"
```

### Linux / macOS (bash)
```powershell
export SONAR_TOKEN="your_token_here"
```

---

## ‚ñ∂Ô∏è 5. Running the Analysis

The project contains a script:

```powershell
run-sonar-analysis.ps1
```

### Script contents:

```powershell
# run-sonar-analysis.ps1

# Check if SONAR_TOKEN is set
if (-not $env:SONAR_TOKEN) {
    Write-Host "Error: SONAR_TOKEN environment variable is not set!" -ForegroundColor Red
    Write-Host "To set the SONAR_TOKEN, use the following command in PowerShell:" -ForegroundColor Yellow
    Write-Host "`$env:SONAR_TOKEN='YourSonarTokenHere'" -ForegroundColor Yellow
    exit 1
}

# Define Maven command arguments
$mvnCommand = @(
    "clean",
    "verify",
    "sonar:sonar",
    "-Dsonar.projectKey=chat-backend",
    "-Dsonar.projectName=Chat Backend",
    "-Dsonar.host.url=http://localhost:9000",
    "-Dsonar.token=$env:SONAR_TOKEN",
    "-Dsonar.java.binaries=target/classes",
    "-Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml"
)


# Inform the user that the analysis is starting
Write-Host "Executing SonarQube analysis..." -ForegroundColor Cyan

# Execute Maven with the defined command
mvn $mvnCommand
```

### Run the script:

```powershell
./run-sonar-analysis.ps1
```

---

### üîç Line-by-Line Explanation

---

## 1. Checking if the token is available

```powershell
if (-not $env:SONAR_TOKEN) {
```

This verifies whether the environment variable `SONAR_TOKEN` has been set. Without a token, SonarQube refuses analysis.

### If the token is missing:

```powershell
Write-Host "Error: SONAR_TOKEN environment variable is not set!" -ForegroundColor Red
```

Displays a red error message.

```powershell
Write-Host "To set the SONAR_TOKEN, use the following command in PowerShell:" -ForegroundColor Yellow
Write-Host "`$env:SONAR_TOKEN='YourSonarTokenHere'" -ForegroundColor Yellow

```

Explains to the user how to set the variable.

```powershell
exit 1
```

Stops execution ‚Äî no point continuing without a token.

---

## Preparing the Maven command

```powershell
$mvnCommand = @(
    "clean",
    "verify",
    "sonar:sonar",

```

This creates a PowerShell array of arguments that will be passed to Maven.

### Breakdown:

| Part          |                               Meaning |
|---------------|--------------------------------------:|
| `clean`       | Deletes `target/` folder before build |
| `verify`      | Runs tests, generates JaCoCo report   |
| `sonar:sonar` |    Invokes the SonarScanner for Maven |

---

### 3. Supply SonarQube parameters

Every argument starting with `-D` is a Maven system property required by SonarScanner.

#### Project identification

```powershell
"-Dsonar.projectKey=chat-backend",
"-Dsonar.projectName=Chat Backend"
```

This must match what you configured in SonarQube UI.

---

#### SonarQube server address

```powershell
"-Dsonar.host.url=http://localhost:9000"
```

This tells the scanner where your SonarQube instance is running.

---

#### Authentication using the environment variable
```powershell
"-Dsonar.token=$env:SONAR_TOKEN"
```

‚úîÔ∏è Correct approach: **token is not hardcoded**

‚úîÔ∏è Secure: the token lives only in the environment

‚úîÔ∏è Works on CI/CD in the same way

---

#### Java bytecode location

```powershell
"-Dsonar.java.binaries=target/classes"
```

SonarQube cannot analyze Java without compiled .class files.

This tells it:

‚û°Ô∏è ‚ÄúLook inside `target/classes` for Java bytecode‚Äù

--- 

#### JaCoCo coverage report

```powershell
"-Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml"
```

This points SonarQube to the **JaCoCo XML report** generate during `mvn verify`.

This is required for:
- Line coverage
- Branch coverage
- Test coverage on UI panel

---

### 4. Printing status message

```powershell
Write-Host "Executing SonarQube analysis..." -ForegroundColor Cyan
```

Just informational.

Useful in CI logs or Windows Terminal

---

#### 5. Executing Maven

```powershell
mvn $mvnCommand
```

This runs Maven with all arguments built earlier:

Equivalent to typing this manually:

```powershell
mvn clean verify sonar:sonar \
  -Dsonar.projectKey=chat-backend \
  -Dsonar.projectName="Chat Backend" \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.token=... \
  -Dsonar.java.binaries=target/classes \
  -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
```

But much easier and reusable.

---

## ‚úÖ Summary of What the Script Automates

| Task                                  | Handled by script   |
|---------------------------------------|--------------------:|
| Ensure token exists                   |                   ‚úÖ |
| Run full Maven lifecycle              |                   ‚úÖ |
| Run tests with coverage               |                   ‚úÖ |
| Generate JaCoCo report                |                   ‚úÖ |
| Upload analysis to SonarQube          |                   ‚úÖ |
| Avoid exposing your token in the repo |                   ‚úÖ |

---

## üß© 6. Maven Plugin Configuration
In `pom.xml` the following plugin is added:
```xml
<plugin>
    <groupId>org.sonarsource.scanner.maven</groupId>
    <artifactId>sonar-maven-plugin</artifactId>
    <version>3.10.0.2594</version>
</plugin>

```

---

## 7. Coverage Reporting (JaCoCo)

JaCoCo XML report is generated automatically by:

```powershell
mvn clean verify
```

The script then uploads:

```powershell
target/site/jacoco/jacoco.xml
```

---

## üéØ 8. Viewing the Report

After the analysis completes, open:

```powershell
http://localhost:9000/dashboard?id=chat-backend
```

You will see:
- Code smells
- Vulnerabilities
- Test coverage
- Duplications
- Maintainability index

---

## üßπ 9. Troubleshooting

### "Not authorized"

Your token is invalid, expired, or missing the `User Token` scope

### "Server is still starting"

Wait until:

```powershell
/api/system/status ‚Üí UP
```

### "Bootstrap HTML error"

---

## üìö 10. Useful Links
- SonarQube docs: https://docs.sonarsource.com/sonarqube/
- Sonar Maven plugin: https://docs.sonarsource.com/sonarqube/analyzing-source-code/scanners/sonarscanner-for-maven/

---

SonarQube integration is now fully automated - just run one script and the analysis is uploaded directly to your local 
SonarQube instance.