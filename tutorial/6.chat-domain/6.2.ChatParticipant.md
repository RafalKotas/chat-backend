# 6.2 `ChatParticipant` (JPA Entity)

`ChatParticipant` represents the `membership of a specific user inside a chat.`<br>
It connects a `User` (via `userId`) with a `chat` and defines the user's role in that chat (e.g., `ADMIN`, `MEMBER`).

It is a part of a **1:N relationship** where one chat has many participants, but each `ChatParticipant` links 
**one chat to one user**.

---

## ‚úî Class Definition

```java
@Entity
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@ToString
@Builder
@Table(name = "chat_participants")
public class ChatParticipant {

    @Id
    @GeneratedValue
    private UUID id;

    @ManyToOne(optional = false)
    @JoinColumn(name = "chat_id")
    private Chat chat;

    @Column(nullable = false)
    private UUID userId;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private ChatRole role;
}
```

---

## üìù Purpose
`ChatParticipant`:
- links a user to a chat
- stores the user's role inside that chat
- determines permissions (adding users, removing users, renaming group, etc.)
- is used to query chats for a given user
- belongs to the `Chat` aggregate

This entity is essential for managing group membership and enforcing chat-level authorization rules.

---

## üìå Field-by-Field Explanation

### `id`

```java
@Id
@GeneratedValue
private UUID id;
```

- unique identifier of the participant entry
- auto-generated UUID
- internal/technical field (not exposed directly in most API responses)

---

### `chat`

```java
@ManyToOne(optional = false)
@JoinColumn(name = "chat_id")
private Chat chat;
```

Defines the **many-to-one** relationship with the `Chat` entity.

### **Notes:**
- `optional = false` means a participant cannot exist without a chat
- mapped by `chat_id` column
- the inverse side of this relationship is:

```java
@OneToMany(mappedBy = "chat")
private List<ChatParticipant> participants;
```

---

### `userId`

```java
@Column(nullable = false)
private UUID userId;
```

Stores the ID of the user who participates in the chat.

### Why not a `User` relation?

- keeps WebSocket code lightweight
- avoids unnecessary joins
- prevents circular dependencies
- easier for caching
- allows future microservices separation

The `User` domain is kept separate by design.

--- 

### `role`

```java
@Enumerated(EnumType.STRING)
@Column(nullable = false)
private ChatRole role;
```

Possible values:

| Role      | Meaning                           |
|:----------|:----------------------------------|
| `ADMIN`   | Can manage group and participants |
| `MEMBER`  | Standard participant              |


### Role purpose:
- enforce simple ACL per group chat
- identify the creator of a group (always ADMIN)
- future support for moderators or read-only roles

---

## üîÑ Lifecycle & Behavior

### Created in:

- `ChatService.createDirectChat()` 
    <br>‚Üí two participants, both `MEMBER`
- `ChatService.createGroupChat()`
    <br>‚Üí creator is `ADMIN`
- `ChatService.addUserToGroup()`
    <br>‚Üí new participant with `MEMBER`

---

### Deleted in:
- `ChatService.removeUserFromGroup()`
    <br> ‚Üí removes a participant and DB row due to orphan removal rules

--- 

### Queried in:
- `ChatRepository.findAllByUserId(UUID)`
  <br>(indirectly to list all chats of a user)
- `ChatParticipantRepository.*`
    <br>(checking membership, existence, preventing duplicates, etc.)

---

## üóÑ Database Table Structure

| Column    | Type   | Constraints   |
|:----------|:-------|:--------------|
| `id`      | UUID   | PK, generated |
| `chat_id` | UUID   | FK ‚Üí chats.id |
| `user_id` | UUID   | NOT NULL      |
| `role`    | STRING | NOT NULL      |

---

## Example JSON representation (typically inside `ChatResponse`)

```json
{
  "userId": "2ed89cdb-0865-4093-bc71-053375a944a5",
  "role": "MEMBER"
}
```

This is returned from the REST layer, never exposing the internal `ChatParticipant` JPA entity directly.

---

### Example JSON representation (typically inside `ChatResponse`)
```json
{
  "userId": "2ed89cdb-0865-4093-bc71-053375a944a5",
  "role": "MEMBER"
}
```

This is returned from the REST layer, never exposing the internal `ChatParticipant` JPA entity directly.

---

## ‚úî Summary

`ChatParticipant` represents a **single user's membership in a chat**, storing:
- the chat they belong to
- their role (`ADMIN`/`MEMBER`)
- persistent mapping inside the chat aggregate

It is:
- essential for group chat management
- lightweight and simple
- designed for efficient role checking and membership queries
- used heavily inside `ChatService` business logic