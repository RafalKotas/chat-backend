# 6.8. ChatController

`ChatController` is the **REST API layer** for managing chats and participants.<br>
Unlike `WsChatController` (which handles real-time communication), this controller exposes HTTP endpoints for:
- creating chats,
- adding/removing participants,
- fetching chat details,
- listing all chats for a user.

It delegates all business logic to `ChatService` and returns DTOs specifically designed for external API use.

--- 

## ✔ Class Definition

```java
@RestController
@RequestMapping("/api/chats")
@RequiredArgsConstructor
public class ChatController {

    private final ChatService chatService;

    @PostMapping("/direct")
    public ChatResponse createDirect(@RequestBody CreateDirectChatRequest req) {
        Chat chat = chatService.createDirectChat(req.user1(), req.user2());
        return ChatResponse.fromEntity(chat);
    }

    @PostMapping("/group")
    public ChatResponse createGroup(@RequestBody CreateGroupChatRequest req,
                                    @RequestParam UUID creatorId) {
        Chat chat = chatService.createGroupChat(req.name(), creatorId);
        return ChatResponse.fromEntity(chat);
    }

    @PostMapping("/{chatId}/participants/{userId}")
    public void addUser(@PathVariable UUID chatId, @PathVariable UUID userId) {
        chatService.addUserToGroup(chatId, userId);
    }

    @DeleteMapping("/{chatId}/participants/{userId}")
    public void removeUser(@PathVariable UUID chatId, @PathVariable UUID userId) {
        chatService.removeUserFromGroup(chatId, userId);
    }

    @GetMapping("/{chatId}")
    public ChatResponse getChat(@PathVariable UUID chatId) {
        return ChatResponse.fromEntity(chatService.getChat(chatId));
    }

    @GetMapping("/user/{userId}")
    public List<ChatResponse> getUserChats(@PathVariable UUID userId) {
        return chatService.getUserChats(userId).stream()
                .map(ChatResponse::fromEntity)
                .toList();
    }
}
```

---

## 1. Responsibilities

### Creating chats
- direct: `/api/chats/direct`
- group: `/api/chats/group`

### Managing participants
- add user to group
- remove user from group

### Retrieving data
- fetch chat details
- fetch all chats for a user

### Delegation to service layer

This controller includes **zero business logic** - everything is delegated to `ChatService`.

This keeps:
- the REST API thin,
- the business rules centralized,
- error handling consistent through the service exceptions.

---

## 2. Endpoints Overview

### 2.1 Create Direct Chat

```
POST /api/chats/direct
```

#### Request Body

```json
{
  "user1": "uuid-1",
  "user2": "uuid-2"
}
```

#### Response

`200 OK`

`ChatResponse`

#### Behavior
- Reuses existing direct chat if present
- Creates a new chat if none exists
- Adds both users as `MEMBER` participants

---

### 2.2 Create Group Chat

```sql
POST /api/chats/group?creatorId=<uuid>
```

#### Request Body

```json
{
  "name": "My Group"
}
```

#### Response

`200 OK`

`ChatResponse`

#### Behavior
- Creates group chat with provided name
- Marks creator as `ADMIN`

---

### 2.3 Add Participant to Group

```
POST /api/chats/{chatId}/participants/{userId}
```

#### Response

`200 OK`

#### Behavior
- Validates that chat is GROUP
- Ensures user is not already a member
- Adds user as `MEMBER`

#### Possible Errors
- `ChatNotFoundException`
- `AlreadyInChatException`
- `UnauthorizedChatOperationException`

---

### 2.4 Remove Participant from Group

```
DELETE /api/chats/{chatId}/participants/{userId}
```

#### Response

`200 OK`

#### Behavior
- Validates that chat is GROUP
- Ensures user is a member
- Removes user

#### Possible Errors
- `ChatNotFoundException`
- `UserNotInChatException`
- `UnauthorizedChatOperationException`

---

### 2.5 Get Chat by ID

```
GET /api/chats/{chatId}
```

#### Response
```json
{
  "id": "...",
  "name": "...",
  "type": "GROUP",
  "participants": [
    { "userId": "...", "role": "ADMIN" }
  ]
}
```

#### Behavior
- Returns chat metadata + participants

---
### 2.6 Get All User Chats

```
GET /api/chats/user/{userId}
```

#### Response

`200 OK`

Array of `ChatResponse` for all chats the user belongs to.

Used by:
- Sidebar chat list
- Chat overview page

---

## 3. DTO Layer Integration

`ChatController` uses the following DTOs:
- `CreateDirectChatRequest`
- `CreateGroupChatRequest`
- `ChatResponse`
- `ChatParticipantResponse`

This ensures that:
- internal JPA structure is never exposed,
- API structure remain stable,
- new entity fields can be added without breaking clients.

---

## 4. Error Handling

All errors originate from:

### `ChatService` **exceptions**:
- `ChatNotFoundException`
- `AlreadyInChatException`
- `UserNotInChatException`
- `UnauthorizedChatOperationException`

**Centralized in**:

`GlobalExceptionHandler`

This keeps API error responses consistent, secure, and predictable.

---

## 5. Dependencies

### Depends on:
- `ChatService`

### Does NOT depend on:
- JPA repositories
- Security components
- WebSocket components

(as expected for a clean REST controller)

---

## 6. Why This Controller Matters

This controller forms the **public HTTP API** for everything related to chats.

Frontend uses it for:
- creating conversations,
- managing membership,
- loading chat list,
- fetching from metadata.
WebSocket controller (`WsChatController`) handles real-time messages, while **ChatController handles persistent 
chat structure.**

This separation simplifies frontend mental model and keeps backend architecture clean.

---

## ✔ Summary

`ChatController` is a concise, fully REST-driven API layer that exposes all structural chat operations while delegating 
business rules to `ChatService`.

It enables:
- creating direct & group chats
- adding/removing participants
- fetching chat details
- retrieving user chat lists

It follows clean architectural patterns:
- thin controllers
- strict DTO use
- centralized business logic
- consistent error handling