# 6.7. ChatService

`ChatService` is the **core business logic layer** responsible for managing chat rooms and participants. 
It orchestrates:
- creation of direct and group chats,
- managing participants,
- validation of operations,
- loading chat details and chat lists.

It sits between:
- controllers (`ChatController`),
- repositories (`ChatRepository`, `ChatParticipantRepository`),
- and domain entities (`Chat`, `ChatParticipant`).

All operations that modify the database are wrapped in `@Transactional` to ensure atomicity.

---

## ✔ Class Definition

```java
@Service
@RequiredArgsConstructor
public class ChatService {

    private static final String CHAT_NOT_FOUND = "Chat not found";

    private final ChatRepository chatRepository;
    private final ChatParticipantRepository participantRepository;

    // methods omitted for summary
}
```

---

## 1. Responsibilities

### ✔ Creating new chats
Both **direct** (1:1) and **group** chats.

### ✔ Ensuring correct domain constraints
- preventing duplicate direct chats
- preventing adding users to direct chats
- ensuring users cannot leave direct chats
- validating whether users belong to a chat

### ✔ Managing participants
- adding new members
- removing existing members
- automatically assigning ADMIN role to group creator

### ✔ Retrieving chat data
- returning chat details
- listing chats for a given user

The service encapsulates all business rules so that controllers remain thin and free of domain logic.

---

## 2. Method-by-Method Documentation

---

### 2.1 `createDirectChat(UUID user1, UUID user2`

#### ✔ Purpose

Creates a new **1-to-1 direct chat** between two users *unless such a chat already exists*.

#### ✔ Steps
**1.** Check if direct chat already exists:
```java
chatRepository.findDirectChatBetweenUsers(user1, user2)
```
**2.** If yes → return the existing chat

**3.** If no → create a new Chat entity with:
- `type = DIRECT`
- `name = null`

**4.** Save it

**5.** Create two participants (`ChatParticipant`), one for each user

**6.** Save participants with `saveAll`

#### ✔ Domain Rule

Only **one direct chat** may exist between two users.

#### ✔ Used by:
- frontend "start direct chat" button
- message screen when creating new conversations

---

### 2.2 `createGroupChat(String name, UUID creatorId`

#### ✔ Purpose

Creates a **group chat** with the given name and assigns the creator as `ADMIN`.

#### ✔ Steps
**1.** Create chat with:
- `type = GROUP`
- `name = provided`

**2.** Save it

**3.** Create a participant entry for the creator with:
- `role = ADMIN`

**4.** Persist creator participant

#### ✔ Domain Rule

Every group must have at least 1 admin.

---

### 2.3 `addUserToGroup(UUID chatId, UUID userId)`

#### ✔ Purpose

Adds a new user into an existing **group chat.**

#### ✔ Steps
**1.** Load chat by ID

**2.** Reject if chat is not of type `GROUP`

**3.** Reject if the user is already in the chat

**4.** Create `ChatParticipant` with:
- `role = MEMBER

**5.** Save participant

#### ✔ Domain Rule

You **cannot** add users to direct chats.

#### Exceptions Thrown
- `ChatNotFoundException`
- `UnauthorizedChatOperationException`
- `AlreadyInChatException`

---

### 2.4 `removeUserFromGroup(UUID chatId, UUID userId)`

#### ✔ Purpose

Removes a user from a group chat.

#### ✔ Steps
**1.** Load chat by ID

**2.** Reject if chat is not of type `GROUP`

**3.** Load participant via `findByChatIdAndUserId`

**4.** If not found → throw `UserNotInChatException`

**5.** Delete participant

#### ✔ Domain Rule

You **cannot** leave direct chats (they neveer lose members).

#### Exceptions Thrown
- `ChatNotFoundException`
- `UnauthorizedChatOperationException`
- `UserNotInChatException`

---

### 2.5 `getChat(UUID chatId)`

#### ✔ Purpose

Fetches a chat by ID or throws.

Used by:
- `ChatController.getChat()`
- frontend chat detail screens

#### Raises
- `ChatNotFoundException`

---

### 2.6 `getUserChats(UUID userId)`

#### ✔ Purpose

Return all chats where the user is a participant.

Uses repository method:

```java
chatRepository.findAllByUserId(userId);
```

Ideal for:
- chat sidebar
- chat list screen
- fetching conversations after login

---

## 3. Extensions Overview

The service uses several custom domain exceptions:
- `ChatNotFoundException`
- `UserNotInChatException`
- `AlreadyInChatException`
- `UnauthorizedChatOperationException`

These provide clear, explicit error signals for both API and potential frontend error handling.

---

## 4. Transaction Management

Methods modifying the database are annotated with:

```java
@Transactional
```

Ensuring:
- atomic operations,
- safe rollback on errors,
- proper cascading operations (especially when saving participants),
- consistent DB state even under concurrency.

---

## 5. Integration Flow

### Used by:

- `ChatController`
- indirectly used by WebSocket events (to validate target rooms)
- future chat-related features (admins, editing chat names, roles)

### Works with:
- `ChatRepository` (chat metadata logic)
- `ChatParticipantRepository` (membership)

---

## 6. Why This Service Matters

Because it centralizes all rules such as:
- who can join what,
- how chats are created,
- how duplicates are prevented,
- how participants are stored,
- what is a valid chat.

It ensures that **controllers stay dumb**, and backend behavior stays consistent regardless of where the 
request originates.

---

## ✔ Summary

`ChatService` is the authoritative business layer of the chat domain that ensures:
- clean creation of direct + group chats
- safe membership updates
- strict domain rule enforcement
- consistent persistent state
- well-structured separation of concerns

The service is now **complete, production-ready, and fully documented.**