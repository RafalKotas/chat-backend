# 6.9. Chat Exceptions

This section documents all custom exceptions used in the **chat domain**.<br>
They enforce business rules, keep service logic expressive, and provide meaningful errors for REST and 
WebSocket clients.

All exceptions extend `RuntimeException`, which allow them to be thrown without mandatory try/catch statements 
and handled cleanly inside the global exception handler (`GlobalExceptionHandler`).

---

## 1. `ChatNotFoundException`

```java
public class ChatNotFoundException extends RuntimeException {
    public ChatNotFoundException(String msg) {
        super(msg);
    }
}
```

### Purpose

Thrown when:
- a requested chat does not exist,
- a chat has been deleted,
- `CHatService.getChat(chatId)` fails,
- or participant operations refer to a non-existing chat.

### Typical Scenario

```java
Chat chat = chatRepository.findById(chatId)
        .orElseThrow(() -> new ChatNotFoundException("Chat not found"));
```

### HTTP Mapping

Handled in `GlobalExceptionHandler` as `404 NOT FOUND`.

---

## 2. `AlreadyInChatException`

```java
public class AlreadyInChatException extends RuntimeException {
    public AlreadyInChatException(String msg) {
        super(msg);
    }
}
```

### Purpose

Thrown when attempting to **add a user to a chat they already belong to.**

Used primarily in:

```java
if (participantRepository.existsByChatIdAndUserId(chatId, userId)) {
        throw new AlreadyInChatException("User already in chat");
}
```

### Prevents
- duplicate participant records
- inconsistent chat membership

### HTTP Mapping

`409 CONFLICT`

---

## 3. `UserNotInChatException`

```java
public class UserNotInChatException extends RuntimeException {
    public UserNotInChatException(String msg) {
        super(msg);
    }
}
```

### Purpose

Thrown when attempting to:
- remove a user from a chat they are not part of,
- access chat-specific operations where user must be a participant.

Typical usage:
```java
participantRepository.findByChatIdAndUserId(chatId, userId)
    .orElseThrow(() -> new UserNotInChatException("User not in chat"));
```

### Prevents
- illegal removals
- inconsistent data
- confusing frontend UX ("user leaves chat they were never in")

### HTTP Mapping

`404 NOT FOUND`

(because participation is missing)

---

## 4. `UnauthorizedChatOperationException`

```java
public class UnauthorizedChatOperationException extends RuntimeException {
    public UnauthorizedChatOperationException(String msg) {
        super(msg);
    }
}
```

### Purpose

Thrown when the attempted operation **is not allowed** for a given chat type.

For example:

```java
if (chat.getType() != ChatType.GROUP) {
    throw new UnauthorizedChatOperationException("Cannot add users to direct chat");
}
```

### Used In
- adding users to a non-group chat
- removing users from a non-group chat

### HTTP Mapping

`403 FORBIDDEN`

---

## 5. Why Exceptions Are Separated by Type?

Each exception:
- reflects a distinct domain rule,
- makes business logic readable,
- translates to clearer API errors for frontend,
- avoids generic "400 Bad Request" responses,
- improve debugging and logging clarity.

Instead of:
```java
throw new RuntimeException("bad");
```

we get:
```java
throw new UserNotInChatException("User not in chat");
```

This immediately explains **what** broke and **why**.

---

## 6. Interaction With GlobalExceptionHandler

These exceptions are handled by:

```java
@ExceptionHandler(...)
public ResponseEntity<ApiError> handle(...)
```

Which maps them to structured JSON responses.

Example response:

```json
{
  "error": "User not in chat",
  "status": 404,
  "timestamp": "2026-02-07T12:33:10Z"
}
```

This keeps your entire API consistent and frontend-friendly.

---

## 7. Summary

| Exception                            | Meaning               | When Thrown                     | Typical HTTP Code |
|:-------------------------------------|:----------------------|:--------------------------------|:------------------|
| `ChatNotFoundException`              | Chat does not exist   | GET/modify non-existing chat    | 404               |
| `AlreadyInChatException`             | User already a member | Add user to group               | 409               |
| `UserNotInChatException`             | User is not a member  | Remove user / restricted access | 404               |
| `UnauthorizedChatOperationException` | Operation not allowed | Modifying a direct chat         | 403               |

---

These exceptions form the **backbone of domain validation** in the messaging module and ensure that all 
chat operations remain consistent, safe, and predictable.