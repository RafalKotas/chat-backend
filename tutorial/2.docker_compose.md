# docker-compose.yml - Infrastructure Setup

This document explains how Docker Compose is used to run the backend infrastructure locally.

---

## üìç Location

```
tools/docker/docker-compose.yml
```

---

## ‚ùì What is Docker Compose?

Docker Compose allows us to define and run **multiple containers** as a single environment.

In this project, it is used to run:
- PostgreSQL (database)
- pgAdmin (database administration UI)

---

## üß± Services Overview

```yaml
services:
  postgres:
  pgadmin:
```

Each service represents one container.

---

## üêò PostgreSQL Service

```yaml
postgres:
  image: postgres:16
  container_name: chat-postgres
  environment:
    POSTGRES_DB: chatdb
    POSTGRES_USER: chatuser
    POSTGRES_PASSWORD: chatpass
```

### Explanation:
- **image** - official PostgreSQL image
- **POSTGRES_DB** - database created at startup
- **POSTGRES_USER / PASSWORD** - database credentials

---

## üîå Ports and Volumes

```yaml
ports:
  - "5432:5432"
volumes:
  - chat_postgres_data:/var/lib/postgresql/data
```

- Port mapping allows backend to connect via `localhost`
- Volume ensures database data persist between container restarts

---

## ‚ù§Ô∏è Health Check

```yaml
healthcheck:
  test: ["CMD-SHELL", "pg_isready - U chatuser"]
  interval: 5s
  timeout: 5s
  retries: 5
```

### What this means - line by line
- **`test: ["CMD-SHELL", ...]`** - tells Docker to run the command inside a shell.
- **`pg_isready -U chatuser`** - checks if PostgreSQL is ready to accept connections.
- **`interval`** - check runs every 5 seconds.
- **`timeout`** - check must complete within 5 seconds.
- **`retries: 5`** - after 5 failures the container is marked as unhealthy.

This ensures PostgreSQL is fully ready before other services depend on it.

---

## üß≠ pgAdmin Service

```yaml
pgadmin:
  image: dpage/pgadmin4:8
  ports:
    - "5050:80"
```

pgAdmin is available at:
```
http://localhost:5050
```

It provides a graphical interface to inspect databases, tables, and data.

---

## ‚ñ∂ Running the Environment

Start containers:
```bash
docker compose -f /tools/docker/docker-compose.yml -p chat up -d
```

Stop containers:
```bash
docker compose -f /tools/docker/docker-compose.yml -p chat down
```

---

## ‚úÖ Result

With Docker Compose running:
- PostgreSQL is available on port 5432
- pgAdmin is available in the browser
- Spring Boot can connect to the database reliably

---

This setup will later be extended with Redis and other services.